# SparseXML: 組み込みシステム向け軽量XMLパーサの評価

## 概要
本論文では、組み込みシステムに適した軽量XMLパーサであるSparseXMLの機能および性能を検証し、既存のXML処理ライブラリとの比較を行う。SparseXMLは1KBの固定バッファを利用することで最小限のメモリ使用量を実現し、イベント駆動型のSAXスタイルインタフェースを提供する。本研究では、関連研究の調査を行った上で、テストスイートを用いた実験による評価を実施した。

## 1. イントロダクション
近年、IoTや組み込みデバイスの増加に伴い、リソース制約の厳しい環境でもXMLデータを扱う需要が高まっている。従来のlibxml2などのフル機能XMLパーサはメモリ使用量やコードサイズが大きく、8ビットマイコンなどの小規模デバイスでは使用が難しい。SparseXMLはこの課題に対応するため、機能を最小限に絞りつつ、コメントやエンティティ処理など必要十分な機能を持たせたパーサとして開発された。

本論文では、SparseXMLの設計方針と主要機能を解説し、関連研究との比較を通して本ライブラリの有用性を明らかにする。また、提供されているテストスイートを用いて正確性と拡張機能の動作を確認し、組み込み環境における利用可能性を評価する。

## 2. 関連研究
XML処理に関する研究や実装は数多く存在する。特に組み込み向けの軽量パーサとしては以下のようなものが挙げられる。

- **TinyXML**: 小規模ながらDOMツリーを構築する方式をとり、メモリ使用量がやや大きい。
- **Mini-XML**: 通常のCライブラリに依存しない設計が特徴だが、DOMベースであるためデータ量に比例してメモリを消費する。
- **libexpat**: ストリーミング型の実装で、メモリ効率は良いもののコードサイズが相対的に大きい。

SparseXMLはSAXスタイルのイベント駆動型であり、DOMツリーを構築しないためメモリ使用量が非常に小さい。また、組み込みシステムで一般的に不足しがちなヒープ領域を一切使用せず、固定サイズのバッファのみで処理を完結させる点が他ライブラリと異なる。このヒープ非依存の設計により、ヒープが存在しないシステムや、動的メモリアロケーションを避ける必要がある組み込み環境でも利用可能である。

## 3. 設計
関連研究で挙げた各ライブラリはいずれも一長一短であり、組み込み用途で"そのまま"利
用するには課題が残る。TinyXMLやMini-XMLはDOMベースのため柔軟だが、データ量に比例
してヒープを消費し、コピペして使うにはソースが大きい。libexpatは高速かつ信頼性も
高いが、コードサイズが数十KB規模となり、ビルドや依存設定が煩雑である。

SparseXMLではこれらの問題点を解決するため、以下の設計方針を採った。

1. **ソースコードの単純化**: `sparsexml.h` を含むわずか3ファイルのみで構成し、外部
   依存を極力排した。必要に応じてプロジェクトへそのままコピーして利用できる。
2. **固定1KBバッファ**: 動的メモリ確保を行わず、構造体内の固定長バッファのみで解析す
   る。これにより、ヒープを持たないマイコンでも動作し、メモリ使用量が予測可能である。
3. **SAXスタイルのイベント駆動**: DOMツリーを構築せず、逐次コールバックで処理する
   ことでメモリフットプリントを最小化する。
4. **機能の選択的実装**: コメント、CDATA、エンティティ、名前空間、簡易DOCTYPEとい
   った基本機能に絞り、DTD検証や高度な名前空間URI解決などは省略した。

こうした設計により、組み込み向けプロジェクトにおいてソースコードをそのまま取り込
み、最小限の構成で利用できる点が特徴となっている。

### 機能比較表
以下にSparseXMLと既存ライブラリの主な機能差を示す。SparseXMLで省かれている機能に
ついては、組み込み環境でのメモリ制約や実装規模を考慮した結果である。

| 機能                     | libexpat | TinyXML | Mini-XML | SparseXML | 省かれている理由 |
|-------------------------|:-------:|:------:|:-------:|:--------:|-----------------|
| DOM構築                 | ×       | ○      | ○       | ×        | メモリ使用を抑えるため |
| SAXスタイル             | ○       | ×      | ×       | ○        | - |
| コメント解析           | ○       | ○      | ○      | ○        | - |
| CDATA                   | ○       | ○      | ○       | ○        | - |
| 標準エンティティ       | ○       | ○      | ○       | ○        | - |
| 数値文字参照           | ○       | △      | △      | ○        | - |
| 拡張HTMLエンティティ   | ×       | ×      | ×       | ○        | 必要最低限の文字集合のみ実装 |
| 名前空間               | ○       | △      | △      | ○        | URI解決など高度機能を省略 |
| DOCTYPE解析           | ○       | ×      | △      | ○        | 検証処理は未実装 |
| DTD検証               | ○       | ×      | ×      | ×        | コードサイズ増大を避けるため |

## 4. 実装
SparseXMLは`sample/simple`に示されるように、ユーザがコールバック関数を登録する形式で利用する。主なAPIは以下のとおりである。

```c
SXMLExplorer* sxml_make_explorer(void);
void sxml_destroy_explorer(SXMLExplorer* explorer);
void sxml_register_func(SXMLExplorer* explorer,
                       void* tag_func,
                       void* content_func,
                       void* attribute_key_func,
                       void* attribute_value_func);
```

エンティティ処理や名前空間処理はオプションとして有効化でき、用途に応じて機能を絞ることが可能である。詳細なAPIはリポジトリの`README.md`で解説されている【F:README.md†L32-L63】。
本リポジトリにはベンチマークやテスト用の多数のファイルが含まれているが、ライブラリ本体は`sparsexml.h`、`sparsexml-priv.h`、`sparsexml.c`の3ファイルのみで構成されている。利用者が確認すべき公開インタフェースは`sparsexml.h`だけである。

## 5. 評価
### 5.1 テスト環境
評価はリポジトリに含まれる自動テストスイートを用いて行った。`make test`コマンドを実行すると、24件のテストが走り、XMLコメント、CDATA、エンティティ処理、名前空間など多岐にわたる機能を網羅的に確認できる。実行結果はすべて成功であった【2efb43†L1-L23】。

### 5.2 メモリ構造と使用量
SparseXMLは、ヒープに依存しない独特のメモリ構造を持つ。従来のXMLパーサが動的メモリアロケーション（malloc/free）を多用するのに対し、SparseXMLは一切ヒープメモリを使用せず、SXMLExplorer構造体内の固定長バッファのみで全ての処理を行う。

```
従来のXMLパーサ（DOM型）:
ヒープメモリ: XMLサイズに比例して増大
├── ノード1 (malloc)
├── ノード2 (malloc)
├── テキスト (malloc)
└── 属性配列 (malloc)

SparseXML（SAX型、ヒープ非依存）:
SXMLExplorer構造体 (約1KB):
├── パーサ状態 (数バイト)
├── 固定バッファ (1KB)
└── コールバック関数ポインタ (数バイト)
```

この設計により、XML文書のサイズに関係なく常に約1KBの固定メモリ使用量を実現している。一般的なDOM型パーサでは、XML文書のサイズに比例してメモリを消費するが、SparseXMLではイベント処理直後にデータを破棄できるためピーク使用量は常に一定である。

### 5.3 包括的ベンチマーク結果
新たに実装した包括的ベンチマークスイートにより、様々なXMLパターンでの性能評価を行った。評価は最適化レベル-O3でコンパイルし、100,000回の解析を基準として実施した。

#### 基本性能比較（100,000回解析）:
| ベンチマーク | SparseXML | Expat | TinyXML | SparseXML優位性 |
|-------------|-----------|-------|---------|----------------|
| 基本XML | 0.031s | 0.114s | 0.002s | Expatより3.6倍高速 |
| 混合コンテンツ | 0.511s | 1.213s | 0.006s | Expatより2.4倍高速 |
| Unicode文字 | 0.345s | 0.830s | 0.005s | Expatより2.4倍高速 |
| 深い入れ子 | 0.004s | 0.015s | 0.001s | Expatより3.8倍高速 |
| 多属性 | 0.003s | 0.022s | 0.0001s | Expatより7.6倍高速 |

#### メモリ使用量の安定性:
全てのテストケースにおいて、SparseXMLのメモリ使用量は約1,144バイトで一定であった。一方、Expatは文書の複雑さに応じて1,048バイトから32MBまで変動し、TinyXMLは96バイトから2.8MBの範囲で変動した。

#### ストレステスト結果:
- **小規模（3階層×5要素）**: SparseXML 0.377s vs Expat 0.769s
- **中規模（5階層×8要素）**: SparseXML 0.571s vs Expat 1.144s  
- **大規模（7階層×10要素）**: SparseXML 0.469s vs Expat 0.915s

全ての条件でSparseXMLがExpatを上回る性能を示し、特に複雑な構造や多数の属性を含むXMLで大幅な優位性を確認した。ただし、TinyXMLは最も高速だが、DOMツリー構築によるメモリ消費の増大というトレードオフがある。

### 5.4 追加テスト
`bench/bench` にはベンチマークだけでなく簡単な検証用テストも備えている。XMLを1回だけ解析し、タグ数や属性数を確認した後にベンチマークを実行する形式だ。実行例を次に示す。

```
$ ./bench/bench 1000
[TEST] counters ok (tags=4, contents=2, attrs=1)
[TEST] expat counters ok (tags=4, contents=2, attrs=1)
Benchmark    | Param    | SparseXML(bytes)   | Expat(bytes)   | TinyXML(bytes) |
 Sparse time(s)   | Expat time(s)    | Tiny time(s)
basic        |     1000 |               1144 |           1048 |             96 |
         0.000578 |         0.002679 |         0.000043
```

この追加テストにより、単に速度を測定するだけでなく、パーサの基本機能が期待どおり動作していることも確認できる。

### 5.5 詳細ベンチマーク分析
拡張されたベンチマークスイートにより、従来の基本テストに加えて新たに3つのカテゴリを追加した：

1. **Mixed Content**: 複雑な構造とテキストを含むXML（実世界のXML文書に近い）
2. **Unicode Content**: 多言語文字、絵文字、特殊記号を含むXML（国際化対応テスト）
3. **Stress Test**: 異なる深度とサイズでの負荷テスト（スケーラビリティ評価）

#### 拡張ベンチマーク結果（O3最適化、200,000回解析）:
| ベンチマーク | パラメータ | SparseXMLメモリ | Expatメモリ | TinyXMLメモリ | SparseXML時間 | Expat時間 | Tiny時間 | 速度比 |
|-------------|-----------|-----------------|-------------|---------------|-------------|-----------|----------|--------|
| basic | 200000 | 1,144 bytes | 1,048 bytes | 96 bytes | 0.059s | 0.250s | 0.005s | 4.2x vs Expat |
| large_mem | 200000 | 1,152 bytes | 3,168 bytes | 5.6MB | 0.015s | 0.034s | 0.002s | 2.3x vs Expat |
| deep_nesting | 200000 | 1,152 bytes | 33MB | 3MB | 0.007s | 0.030s | 0.001s | 4.4x vs Expat |
| many_attrs | 200000 | 1,152 bytes | 23MB | 2.3MB | 0.006s | 0.068s | 0.0005s | 12.1x vs Expat |
| mixed | 200000 | 1,144 bytes | 1,048 bytes | 1,808 bytes | 1.141s | 2.480s | 0.011s | 2.2x vs Expat |
| unicode | 200000 | 1,144 bytes | 1,048 bytes | 1,568 bytes | 0.677s | 1.710s | 0.011s | 2.5x vs Expat |
| stress_lg | 40000 | 1,144 bytes | 1,048 bytes | 9,728 bytes | 0.928s | 1.838s | 0.017s | 2.0x vs Expat |

#### 主要な発見:
1. **メモリ安定性**: SparseXMLは全ての条件でメモリ使用量が1KB前後で一定
2. **一貫した高速性**: Expatに対して2-12倍の速度優位性を全てのテストで確認
3. **スケーラビリティ**: 文書の複雑さに関係なく安定した性能を維持
4. **Unicode対応**: 多言語文字を含む複雑なXMLでも高い処理性能を実現
## 6. 考察
SparseXMLの最大の利点は、メモリフットプリントの小ささと依存性の少なさである。イベント駆動型であるため、ユーザは必要な情報のみを逐次処理でき、不要なデータの保持を避けられる。一方で、DTD検証や高度な名前空間URI処理など、複雑なXML仕様には対応していないため、利用範囲は限定される。今後、オプションとしてバッファサイズの可変化や、ストリーミング性能の向上を図ることで、より幅広い応用が期待できる。

## 7. 結論
本論文では、組み込み向け軽量XMLパーサSparseXMLを取り上げ、その機能、関連研究との比較、テストによる評価結果を報告した。SparseXMLは1KBバッファのみで動作し、コメントやエンティティ処理など実用的な機能を備えている。テストスイートの結果から基本的なXML処理に必要な機能が正しく実装されていることが確認できた。今後はより大規模なベンチマークや実際の組み込みデバイス上での性能測定を通じて、さらなる最適化を検討していく。

## 8. 参考文献
1. Clark, J., & Expat project. "Expat XML Parser." 1998.
2. Lee, C. "TinyXML: XML Parser for Small Projects." 2000.
3. Drake, M. "Mini-XML." 2003.
4. SparseXML Project. "SparseXML: Minimal XML Parser for Embedded Systems." Git Repository, 2023.

