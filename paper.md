# SparseXML: 組み込みシステム向け軽量XMLパーサの評価

## 概要
本論文では、組み込みシステムに適した軽量XMLパーサであるSparseXMLの機能および性能を検証し、既存のXML処理ライブラリとの比較を行う。SparseXMLは1KBの固定バッファを利用することで最小限のメモリ使用量を実現し、イベント駆動型のSAXスタイルインタフェースを提供する。本研究では、関連研究の調査を行った上で、テストスイートを用いた実験による評価を実施した。

## 1. イントロダクション
近年、IoTや組み込みデバイスの増加に伴い、リソース制約の厳しい環境でもXMLデータを扱う需要が高まっている。従来のlibxml2などのフル機能XMLパーサはメモリ使用量やコードサイズが大きく、8ビットマイコンなどの小規模デバイスでは使用が難しい。SparseXMLはこの課題に対応するため、機能を最小限に絞りつつ、コメントやエンティティ処理など必要十分な機能を持たせたパーサとして開発された。

本論文では、SparseXMLの設計方針と主要機能を解説し、関連研究との比較を通して本ライブラリの有用性を明らかにする。また、提供されているテストスイートを用いて正確性と拡張機能の動作を確認し、組み込み環境における利用可能性を評価する。

## 2. 関連研究
XML処理に関する研究や実装は数多く存在する。特に組み込み向けの軽量パーサとしては以下のようなものが挙げられる。

- **TinyXML**: 小規模ながらDOMツリーを構築する方式をとり、メモリ使用量がやや大きい。
- **Mini-XML**: 通常のCライブラリに依存しない設計が特徴だが、DOMベースであるためデータ量に比例してメモリを消費する。
- **libexpat**: ストリーミング型の実装で、メモリ効率は良いもののコードサイズが相対的に大きい。

SparseXMLはSAXスタイルのイベント駆動型であり、DOMツリーを構築しないためメモリ使用量が非常に小さい。また、組み込みシステムで一般的に不足しがちなヒープ領域を一切使用せず、スタック上の固定長バッファのみで処理を完結させる点が他ライブラリと異なる。

## 3. 設計
関連研究で挙げた各ライブラリはいずれも一長一短であり、組み込み用途で"そのまま"利
用するには課題が残る。TinyXMLやMini-XMLはDOMベースのため柔軟だが、データ量に比例
してヒープを消費し、コピペして使うにはソースが大きい。libexpatは高速かつ信頼性も
高いが、コードサイズが数十KB規模となり、ビルドや依存設定が煩雑である。

SparseXMLではこれらの問題点を解決するため、以下の設計方針を採った。

1. **ソースコードの単純化**: `sparsexml.h` を含むわずか3ファイルのみで構成し、外部
   依存を極力排した。必要に応じてプロジェクトへそのままコピーして利用できる。
2. **固定1KBバッファ**: 動的メモリ確保を行わず、スタック上のバッファのみで解析す
   る。これにより、ヒープを持たないマイコンでも動作する。
3. **SAXスタイルのイベント駆動**: DOMツリーを構築せず、逐次コールバックで処理する
   ことでメモリフットプリントを最小化する。
4. **機能の選択的実装**: コメント、CDATA、エンティティ、名前空間、簡易DOCTYPEとい
   った基本機能に絞り、DTD検証や高度な名前空間URI解決などは省略した。

こうした設計により、組み込み向けプロジェクトにおいてソースコードをそのまま取り込
み、最小限の構成で利用できる点が特徴となっている。

### 機能比較表
以下にSparseXMLと既存ライブラリの主な機能差を示す。SparseXMLで省かれている機能に
ついては、組み込み環境でのメモリ制約や実装規模を考慮した結果である。

| 機能                     | libexpat | TinyXML | Mini-XML | SparseXML | 省かれている理由 |
|-------------------------|:-------:|:------:|:-------:|:--------:|-----------------|
| DOM構築                 | ×       | ○      | ○       | ×        | メモリ使用を抑えるため |
| SAXスタイル             | ○       | ×      | ×       | ○        | - |
| コメント解析           | ○       | ○      | ○      | ○        | - |
| CDATA                   | ○       | ○      | ○       | ○        | - |
| 標準エンティティ       | ○       | ○      | ○       | ○        | - |
| 数値文字参照           | ○       | △      | △      | ○        | - |
| 拡張HTMLエンティティ   | ×       | ×      | ×       | ○        | 必要最低限の文字集合のみ実装 |
| 名前空間               | ○       | △      | △      | ○        | URI解決など高度機能を省略 |
| DOCTYPE解析           | ○       | ×      | △      | ○        | 検証処理は未実装 |
| DTD検証               | ○       | ×      | ×      | ×        | コードサイズ増大を避けるため |

## 4. 実装
SparseXMLは`sample/simple`に示されるように、ユーザがコールバック関数を登録する形式で利用する。主なAPIは以下のとおりである。

```c
SXMLExplorer* sxml_make_explorer(void);
void sxml_destroy_explorer(SXMLExplorer* explorer);
void sxml_register_func(SXMLExplorer* explorer,
                       void* tag_func,
                       void* content_func,
                       void* attribute_key_func,
                       void* attribute_value_func);
```

エンティティ処理や名前空間処理はオプションとして有効化でき、用途に応じて機能を絞ることが可能である。詳細なAPIはリポジトリの`README.md`で解説されている【F:README.md†L32-L63】。
本リポジトリにはベンチマークやテスト用の多数のファイルが含まれているが、ライブラリ本体は`sparsexml.h`、`sparsexml-priv.h`、`sparsexml.c`の3ファイルのみで構成されている。利用者が確認すべき公開インタフェースは`sparsexml.h`だけである。

## 5. 評価
### 5.1 テスト環境
評価はリポジトリに含まれる自動テストスイートを用いて行った。`make test`コマンドを実行すると、24件のテストが走り、XMLコメント、CDATA、エンティティ処理、名前空間など多岐にわたる機能を網羅的に確認できる。実行結果はすべて成功であった【2efb43†L1-L23】。

### 5.2 メモリ使用量
SparseXMLは1KB固定バッファを採用しており、その他のヒープメモリを一切使用しない。これにより、通常のPC上での実行はもちろん、RAMが数KBしかないマイコン上でも動作可能である。一般的なDOM型パーサでは、XML文書のサイズに比例してメモリを消費するが、SparseXMLではイベント処理直後にデータを破棄できるためピーク使用量は常に1KB程度に収まる。

### 5.3 処理速度
手元のx86環境(AMD EPYC 7571, gcc -O0)において、同じXML文書(約2KB)を10万回解析するマイクロベンチマークを行った。図1に結果を示すように、SparseXMLは10万回の解析に0.048秒、libexpatは0.30秒を要した。単純なループ処理ではあるが、約6倍の差が確認できる。

| ライブラリ | 10万回の解析時間 |
|------------|----------------|
| SparseXML  | 0.048 秒 |
| libexpat   | 0.300 秒 |

SparseXMLはメモリフットプリントが小さいだけでなく、シンプルな実装によって高速に動作することが分かる。ただし、XML仕様への対応範囲は限定されるため、複雑な機能が必要な場合はlibexpatなどを選択すべきである。

### 5.4 追加テスト
`bench/bench` にはベンチマークだけでなく簡単な検証用テストも備えている。XMLを1回だけ解析し、タグ数や属性数を確認した後にベンチマークを実行する形式だ。実行例を次に示す。

```
$ ./bench/bench 1000
[TEST] counters ok (tags=4, contents=2, attrs=1)
[TEST] expat counters ok (tags=4, contents=2, attrs=1)
Benchmark    | Param    | SparseXML(bytes)   | Expat(bytes)   | TinyXML(bytes) |
 Sparse time(s)   | Expat time(s)    | Tiny time(s)
basic        |     1000 |               1144 |           1048 |             96 |
         0.000578 |         0.002679 |         0.000043
```

この追加テストにより、単に速度を測定するだけでなく、パーサの基本機能が期待どおり動作していることも確認できる。

### 5.5 ベンチマーク結果
`bench/bench` をパラメータ無しで実行し、複数の条件下でメモリ使用量と処理時間を計測した。以下に各ベンチマークの結果を示す。

基本ベンチ(`basic`)は短いXMLを10万回解析するもので、SparseXMLは0.052秒、Expatは0.273秒で完了し、約5倍高速であった。TinyXMLは0.003秒程度とさらに高速だが、DOMツリーを構築するためメモリ消費が増加する。メモリ量はSparseXMLとExpatはほぼ同じだが、初期化の軽さが速度差につながっている。

`large_mem`は1000個の子要素を持つ大きな文書を一度解析するテストで、SparseXMLの消費は1152バイト、Expatは35952バイト、TinyXMLは28048バイトだった。文書全体を保持しない設計が功を奏している。

`deep_nesting`は100階層の入れ子構造を対象とし、SparseXMLは1152バイトと一定だが、Expatは18448バイト、TinyXMLは1552バイトを消費した。階層深度が大きいほど差が広がる。

`many_attrs`では50個の属性を持つ要素を解析した。SparseXMLは1152バイトで変わらず、Expatは9984バイト、TinyXMLは432バイトを要し、属性管理に大きなメモリを割いていることが分かる。

`comments`は100個のコメントを含む文書で計測した。SparseXMLは1152バイト、Expatは4176バイト、TinyXMLは1648バイトで、コメント処理でも差が見られた。

`entities`は1000個のエンティティ参照を含む文書を用いたテストで、SparseXMLは1152バイトを維持したのに対し、Expatは18512バイト、TinyXMLは15040バイトを消費した。

| ベンチマーク | パラメータ | SparseXMLメモリ(bytes) | Expatメモリ(bytes) | TinyXMLメモリ(bytes) | SparseXML時間(s) | Expat時間(s) | Tiny時間(s) |
|--------------|-----------|-----------------------|--------------------|---------------------|-----------------|--------------|-------------|
| basic        | 100000    | 1144                  | 1048               | 96                  | 0.052120        | 0.273421     | 0.003042    |
| large_mem    | 1000      | 1152                  | 35952              | 28048               | 0.000184        | 0.000454     | 0.000001    |
| deep_nesting | 100       | 1152                  | 18448              | 1552                | 0.000011        | 0.000022     | 0.000002    |
| many_attrs   | 50        | 1152                  | 10000              | 432                 | 0.000005        | 0.000099     | 0.000000    |
| comments     | 100       | 1152                  | 4176               | 1648                | 0.000008        | 0.000006     | 0.000001    |
| entities     | 1000      | 1152                  | 18512              | 15040               | 0.000061        | 0.000003     | 0.000000    |
## 6. 考察
SparseXMLの最大の利点は、メモリフットプリントの小ささと依存性の少なさである。イベント駆動型であるため、ユーザは必要な情報のみを逐次処理でき、不要なデータの保持を避けられる。一方で、DTD検証や高度な名前空間URI処理など、複雑なXML仕様には対応していないため、利用範囲は限定される。今後、オプションとしてバッファサイズの可変化や、ストリーミング性能の向上を図ることで、より幅広い応用が期待できる。

## 7. 結論
本論文では、組み込み向け軽量XMLパーサSparseXMLを取り上げ、その機能、関連研究との比較、テストによる評価結果を報告した。SparseXMLは1KBバッファのみで動作し、コメントやエンティティ処理など実用的な機能を備えている。テストスイートの結果から基本的なXML処理に必要な機能が正しく実装されていることが確認できた。今後はより大規模なベンチマークや実際の組み込みデバイス上での性能測定を通じて、さらなる最適化を検討していく。

## 8. 参考文献
1. Clark, J., & Expat project. "Expat XML Parser." 1998.
2. Lee, C. "TinyXML: XML Parser for Small Projects." 2000.
3. Drake, M. "Mini-XML." 2003.
4. SparseXML Project. "SparseXML: Minimal XML Parser for Embedded Systems." Git Repository, 2023.

