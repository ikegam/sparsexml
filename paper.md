# SparseXML: 組み込みシステム向け軽量XMLパーサの評価

## 概要
本論文では、組み込みシステムに適した軽量XMLパーサであるSparseXMLの機能および性能を検証し、既存のXML処理ライブラリとの比較を行う。SparseXMLは1KBの固定バッファを利用することで最小限のメモリ使用量を実現し、イベント駆動型のSAXスタイルインタフェースを提供する。本研究では、関連研究の調査を行った上で、テストスイートを用いた実験による評価を実施した。

## 1. イントロダクション
近年、IoTや組み込みデバイスの増加に伴い、リソース制約の厳しい環境でもXMLデータを扱う需要が高まっている。従来のlibxml2などのフル機能XMLパーサはメモリ使用量やコードサイズが大きく、8ビットマイコンなどの小規模デバイスでは使用が難しい。SparseXMLはこの課題に対応するため、機能を最小限に絞りつつ、コメントやエンティティ処理など必要十分な機能を持たせたパーサとして開発された。

本論文では、SparseXMLの設計方針と主要機能を解説し、関連研究との比較を通して本ライブラリの有用性を明らかにする。また、提供されているテストスイートを用いて正確性と拡張機能の動作を確認し、組み込み環境における利用可能性を評価する。

## 2. 関連研究
XML処理に関する研究や実装は数多く存在する。特に組み込み向けの軽量パーサとしては以下のようなものが挙げられる。

- **TinyXML**: 小規模ながらDOMツリーを構築する方式をとり、メモリ使用量がやや大きい。
- **Mini-XML**: 通常のCライブラリに依存しない設計が特徴だが、DOMベースであるためデータ量に比例してメモリを消費する。
- **libexpat**: ストリーミング型の実装で、メモリ効率は良いもののコードサイズが相対的に大きい。

SparseXMLはSAXスタイルのイベント駆動型であり、DOMツリーを構築しないためメモリ使用量が非常に小さい。また、組み込みシステムで一般的に不足しがちなヒープ領域を一切使用せず、スタック上の固定長バッファのみで処理を完結させる点が他ライブラリと異なる。

## 3. 実装
SparseXMLは`sample/simple`に示されるように、ユーザがコールバック関数を登録する形式で利用する。主なAPIは以下のとおりである。

```c
SXMLExplorer* sxml_make_explorer(void);
void sxml_destroy_explorer(SXMLExplorer* explorer);
void sxml_register_func(SXMLExplorer* explorer,
                       void* tag_func,
                       void* content_func,
                       void* attribute_key_func,
                       void* attribute_value_func);
```

エンティティ処理や名前空間処理はオプションとして有効化でき、用途に応じて機能を絞ることが可能である。詳細なAPIはリポジトリの`README.md`で解説されている【F:README.md†L23-L44】。

## 4. 評価
### 4.1 テスト環境
評価はリポジトリに含まれる自動テストスイートを用いて行った。`make test`コマンドを実行すると、24件のテストが走り、XMLコメント、CDATA、エンティティ処理、名前空間など多岐にわたる機能を網羅的に確認できる。実行結果はすべて成功であった【2efb43†L1-L23】。

### 4.2 メモリ使用量
SparseXMLは1KB固定バッファを採用しており、その他のヒープメモリを一切使用しない。これにより、通常のPC上での実行はもちろん、RAMが数KBしかないマイコン上でも動作可能である。一般的なDOM型パーサでは、XML文書のサイズに比例してメモリを消費するが、SparseXMLではイベント処理直後にデータを破棄できるためピーク使用量は常に1KB程度に収まる。

### 4.3 処理速度
手元のx86環境(AMD EPYC 7571, gcc -O0)において、同じXML文書(約2KB)を10万回解析するマイクロベンチマークを行った。図1に結果を示すように、SparseXMLは10万回の解析に0.048秒、libexpatは0.30秒を要した。単純なループ処理ではあるが、約6倍の差が確認できる。

| ライブラリ | 10万回の解析時間 |
|------------|----------------|
| SparseXML  | 0.048 秒 |
| libexpat   | 0.300 秒 |

SparseXMLはメモリフットプリントが小さいだけでなく、シンプルな実装によって高速に動作することが分かる。ただし、XML仕様への対応範囲は限定されるため、複雑な機能が必要な場合はlibexpatなどを選択すべきである。

### 4.4 追加テスト
`examples/bench` にはベンチマークだけでなく簡単な検証用テストも備えている。XMLを1回だけ解析し、タグ数や属性数を確認した後にベンチマークを実行する形式だ。実行例を次に示す。

```
$ ./examples/bench 1000
[TEST] counters ok (tags=4, contents=2, attrs=1)
SparseXML: 0.05 seconds for 1000 iterations
Expat:     0.30 seconds for 1000 iterations
```

この追加テストにより、単に速度を測定するだけでなく、パーサの基本機能が期待どおり動作していることも確認できる。

## 5. 考察
SparseXMLの最大の利点は、メモリフットプリントの小ささと依存性の少なさである。イベント駆動型であるため、ユーザは必要な情報のみを逐次処理でき、不要なデータの保持を避けられる。一方で、DTD検証や高度な名前空間URI処理など、複雑なXML仕様には対応していないため、利用範囲は限定される。今後、オプションとしてバッファサイズの可変化や、ストリーミング性能の向上を図ることで、より幅広い応用が期待できる。

## 6. 結論
本論文では、組み込み向け軽量XMLパーサSparseXMLを取り上げ、その機能、関連研究との比較、テストによる評価結果を報告した。SparseXMLは1KBバッファのみで動作し、コメントやエンティティ処理など実用的な機能を備えている。テストスイートの結果から基本的なXML処理に必要な機能が正しく実装されていることが確認できた。今後はより大規模なベンチマークや実際の組み込みデバイス上での性能測定を通じて、さらなる最適化を検討していく。

## 参考文献
1. Clark, J., & Expat project. "Expat XML Parser." 1998.
2. Lee, C. "TinyXML: XML Parser for Small Projects." 2000.
3. Drake, M. "Mini-XML." 2003.
4. SparseXML Project. "SparseXML: Minimal XML Parser for Embedded Systems." Git Repository, 2023.

